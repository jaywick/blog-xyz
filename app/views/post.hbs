<!DOCTYPE html>

<html>
<head>
    <title>{{title}} | blog-xyz</title>
    {{> metalinks}}
    {{#if isAdmin}}
    <link rel="stylesheet" href="/admin.styles.css" type="text/css" />
    {{/if}}
</head>
<body>
    {{> smallheader}}

    {{#switch mode}}
        {{#case "read"}}
        <div class="blog-post">
            <div class="blog-date">{{humanizedDate}}</div>
            {{#if isAdmin}}
                <span class="blog-status {{status}}">{{status}}</span>
            {{/if}}
            <h1 class="blog-title">{{title}} {{#if isAdmin}}<a class="admin-action edit-post fa fa-pencil" href="/blog/edit/{{id}}"></a>{{/if}}</h1>
            <img class="post-feature-image" src="{{{featureImageUrl}}}">
            <p>{{{bodyHtml}}}</p>

            Tagged under: {{#each tags}}<a href="/blog/tag/{{this}}" class="post-tag">{{this}}</a>{{/each}}
        </div>
        
        <div class="blog-comments-section">
            <div class="blog-comments">
                <h1>Responses</h1>
                <div class="comments-container">
                    <span class="loading-comments-text"><i class="fa fa-spinner" style=""></i> Loading comments...</span>
                </div>
            </div>
        </div>
        {{/case}}
        
        {{#case "update" "create"}}
            {{#if isAdmin}}
            <div class="blog-post">
                <div class="blog-meta">
                    <select id="post-status">
                        <option value="draft" {{#if isDraft}}selected="selected"{{/if}}>Draft</option>
                        <option value="publish" {{#if isPublished}}selected="selected"{{/if}}>Published</option>
                    </select>
                    <input type="text" id="blog-slug" value="{{slug}}" placeholder="slug"/>
                    <input type="text" id="blog-featured-image-url" value="{{featureImage}}" placeholder="featured image"/>
                </div>

                <h2 contenteditable id="blog-title">{{title}}</h2>
                <textarea id="post-body-editor">{{body}}</textarea>
                <input id="blog-id" type="hidden" value="{{id}}"/>

                {{#switch mode}}
                    {{#case "create"}}
                        <a class="admin-action save-post" href="javascript:save('add')">Create post</a>
                    {{/case}}
                    {{#case "update"}}
                        <a class="admin-action save-post" href="javascript:save('edit')">Save post</a>
                    {{/case}}
                {{/switch}}
            </div>
            {{/if}}
        {{/case}}
    {{/switch}}

    <script src="/post.js"></script>
    <script>
        var commentsPlaceholder = window.document.querySelector(".comments-container");  

        commentsLoaded = function(data) {
            var commentsHtml = data.map(x => 
                `<div class="comment ${x.cssClass}">
                    <div class="comment-meta">
                        <span class="author">@${x.author}</span>
                        &middot;
                        <span class="comment-date" title="${x.humanizedDate}">${x.relativeDate}</span>
                        {{#if isAdmin}}
                            <a href="javascript:approveComment('${x._id}', true)">approve</a>
                            <a href="javascript:approveComment('${x._id}', false)">unapprove</a>
                        {{/if}}
                    </div>
                    <span class="text">${x.text}</span>
                </div>`).join("\n");

            var addCommentsHtml = `
                <div class="add-comment">
                    <textarea class="add-comment-text" cols="40" rows="5" placeholder="Enter your comment"></textarea>
                    <input type="hidden" id="post-id" value="{{id}}" /> 
                    <input class="add-comment-author" placeholder="{{commentAuthor}}" title="Leave blank for an autogenerated alias" />
                    <a class="post-comment" href="javascript:postComment()">Post</a>
                </div>`;

            commentsPlaceholder.innerHTML = addCommentsHtml + commentsHtml;
        }
        
        loadComments();

        function postComment() {
            if (peek(".add-comment-text") === "") {
                alert("Cannot post empty comment");
                return;
            }
            
            if (peek(".add-comment-author").trim() === "jaywick" || peek(".add-comment-author").trim() === "jay wick") {
                alert("Cannot choose this alias");
                return;
            }
            
            var onPost = function() {
                alert("Comment will be made public after moderation");
                loadComments();
            }

            var author = peek(".add-comment-author") || window.document.querySelector(".add-comment-author").placeholder;
            post("/blog/save/comment", { postID: "#post-id", text: ".add-comment-text", author}, onPost);
        }

        function loadComments() {
            get("/blog/comments/{{id}}", commentsLoaded);
        }
    </script>
    <script>
        var appendSlug = JSON.parse('{{{json appendSlug}}}');

        if (appendSlug != null) {
            var newUrl;

            if (window.location.toString().substr(-1) === "/")
                newUrl = window.location.toString() + appendSlug;
            else
                newUrl = window.location.toString() + "/" + appendSlug;

            window.history.replaceState(document.title, document.title, newUrl);
        }
    </script>
    {{#if isAdmin}}
    <script>
        function approveComment(id, value) {
            post("/blog/save/approve-comment/", { id: id, state: value }, loadComments);
        }

        function save(mode) {
            post("/blog/save/" + mode, {
                id: "#blog-id",
                title: "#blog-title",
                body: "#post-body-editor",
                status: "#post-status",
                slug: "#blog-slug",
                featureImage: "#blog-featured-image-url"
            });
        }
    </script>
    {{/if}}

    {{> footer}}

</body>
</html>